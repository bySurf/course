<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editing – bySurf Course</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f0f0f; --fg:#eaeaea; --muted:#b5b5b5; --brand:#009dff; }
    body{margin:0; background:var(--bg); color:var(--fg); font-family:'Roboto Mono', monospace; font-weight:700}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px 80px}

    /* Hero banner */
    .hero{position:relative; min-height:clamp(220px, 40vw, 420px); display:flex; align-items:flex-end}
    .hero::before{content:""; position:absolute; inset:0; background:url('https://i.ytimg.com/vi/7FvFOaXoFco/maxresdefault.jpg') center/cover no-repeat}
    .hero::after{content:""; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(15,15,15,0) 0%, #0f0f0f 80%)}
    .hero-content{position:relative; z-index:1; max-width:1200px; margin:0 auto; width:100%; padding:40px 20px 24px}
    .title{font-family:'Inter', system-ui; font-weight:800; font-size:clamp(28px,3.6vw,48px)}
    .desc{color:var(--muted); font-size:clamp(14px,1.7vw,18px)}

    .controls{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:18px 0 16px}
    .btn{appearance:none; transition: .3s ease; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; background:var(--brand); color:#fff; font-family:'Roboto Mono', monospace; font-weight:700; font-size:14px; text-transform: uppercase;}
    .btn:hover{background: #0080cf;}
    .search{flex:1 1 260px}
    .search input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #1f1f1f; background:#121212; color:var(--fg)}

    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; margin-top:16px}
    .card{background:#141414; border:1px solid #1f1f1f; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; position:relative}
    .thumb-wrap{position:relative}
    .thumb{aspect-ratio:16/9; width:100%; object-fit:cover; display:block; transition:filter .2s ease}
    .duration{position:absolute; right:8px; bottom:8px; padding:4px 12px; border-radius:8px; background:rgba(0,0,0,.8); font-size:12px; color:#fff}
    .progress{position:absolute; left:0; right:0; bottom:0; height:4px; background:rgba(255,255,255,.08)}
    .progress span{display:block; height:100%; width:0; background:var(--brand)}
    .card.watched .thumb{filter:brightness(0.45) blur(1.5px)}
    .watched-overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; opacity:0; transition:.2s}
    .card.watched .watched-overlay{opacity:1}
    .watched-overlay span{font-family:'Roboto Mono', monospace; font-weight:700; background:rgb(255, 255, 255); color: black; padding:8px 12px; border-radius:10px; text-transform: uppercase;}
    .meta{padding:12px; display:grid; gap:8px}
    .meta h3{font-family:'Inter', system-ui; font-weight:800; font-size:16px; margin:0}
    .meta .sub{color:var(--muted); font-size:12px}
    .card .watch{margin:4px 12px 14px}

    /* Modal */
    dialog::backdrop{background:rgba(0,0,0,.6)}
    dialog{border:none; padding:0; background:transparent; overflow:visible; max-width:none}
    .player-wrap{position:relative; width:min(92vw, 1120px); margin:auto}
    .player-shell{position:relative; width:100%; background:#000; border-radius:16px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .player-shell::before{content:""; display:block; padding-top:56.25%}
    #player{position:absolute; inset:0; width:100% !important; height:100% !important}

    /* Close button INSIDE dialog's top layer */
    .top-close{position:fixed; top:max(16px, env(safe-area-inset-top)); right:max(16px, env(safe-area-inset-right)); border:none; background:rgba(0,0,0,.7); color:#fff; border-radius:999px; width:42px; height:42px; font-size:20px; line-height:42px; cursor:pointer; z-index:2147483647}

    footer{margin-top:36px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="hero"><div class="hero-content"><h1 class="title">Editing</h1><p class="desc">Learn about specific types of edits in bySurf videos and learn how to re-create them.</p></div></div>
  <div class="wrap">
    <div class="controls"><button class="btn" id="playAll">Play All</button><div class="search"><input id="q" type="search" placeholder="Filter episodes… (title)" style="font-family: 'Roboto Mono'; font-weight: bold;"></div></div>
    <section id="episodes" class="grid"></section>
    <footer><p>© Studio bySurf, a KDR GbR owned company</p></footer>
  </div>

  <dialog id="modal">
    <div class="player-wrap"><div class="player-shell"><div id="player"></div></div></div>
    <button class="top-close" id="closeBtn" aria-label="Close video">✕</button>
  </dialog>

  <script>
    const PLAYLIST_ID='PL2pwVisjstu0wo1Un4OqJFFOjDiuRDgSM';
    let player,playlistVideoIds=[],items=[],filtered=[],durations=new Map();
    const WATCH_KEY='watchedVideos',PROG_KEY='progressMapV1';
    let watched=new Set(JSON.parse(localStorage.getItem(WATCH_KEY)||'[]'));
    let progress=new Map(Object.entries(JSON.parse(localStorage.getItem(PROG_KEY)||'{}')));
    const saveWatched=()=>localStorage.setItem(WATCH_KEY,JSON.stringify([...watched]));
    const saveProgress=()=>localStorage.setItem(PROG_KEY,JSON.stringify(Object.fromEntries(progress)));
    let tickHandle=null;

    // Load YouTube API
    const tag=document.createElement('script');tag.src='https://www.youtube.com/iframe_api';document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady=()=>{player=new YT.Player('player',{playerVars:{listType:'playlist',list:PLAYLIST_ID,modestbranding:1,rel:0},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}})};

    async function onPlayerReady(){await hydratePlaylistIds();buildCards();}
    function onPlayerStateChange(ev){
      if(ev.data===YT.PlayerState.PLAYING){const vid=safeVideoId(); if(vid){ if(!durations.has(vid)) fetchDurationFor(vid); startProgressTicker(); }}
      else if(ev.data===YT.PlayerState.PAUSED){stopProgressTicker();}
      else if(ev.data===YT.PlayerState.ENDED){stopProgressTicker(); const vid=safeVideoId(); if(vid){ watched.add(vid); progress.set(vid,durations.get(vid)||0); saveWatched(); saveProgress(); render(); }}
    }

    function startProgressTicker(){ if(tickHandle) return; tickHandle=setInterval(()=>{ const vid=safeVideoId(); if(!vid) return; let t=0,d=0; try{ t=player.getCurrentTime(); d=player.getDuration(); }catch(_){} if(d&&t>=0){ progress.set(vid,t); if(durations.get(vid)!==d) durations.set(vid,d); saveProgress(); updateCardProgress(vid); } },1000); }
    function stopProgressTicker(){ if(tickHandle){ clearInterval(tickHandle); tickHandle=null; } }

    function safeVideoId(){ try{ const vd=player.getVideoData(); return vd&&vd.video_id?vd.video_id:null; }catch(_){ return null; } }

    function hydratePlaylistIds(){ let tries=0; return new Promise(res=>{ const t=setInterval(()=>{ tries++; try{ const ids=player.getPlaylist(); if(Array.isArray(ids)&&ids.length){ playlistVideoIds=ids; clearInterval(t); res(); return; } }catch(_){} if(tries>40){ clearInterval(t); res(); } },250); }); }

    async function buildCards(){ const c=document.getElementById('episodes'); c.innerHTML=''; if(!playlistVideoIds.length){ c.innerHTML='<p class="sub">If no episodes, click Play All once then close.</p>'; return; } items=await Promise.all(playlistVideoIds.map(async(v,i)=>({ id:v, title:await fetchTitle(v)||`Episode ${i+1}`, idx:i }))); filtered=items.slice(); render(); fetchAllDurationsSequential(); }
    async function fetchTitle(vid){ try{ const url=`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${vid}&format=json`; const r=await fetch(url); if(!r.ok) throw 0; const d=await r.json(); return d.title; }catch(_){ return ''; } }

    function render(){ const c=document.getElementById('episodes'); c.innerHTML=''; filtered.forEach((it,i)=>{ const isW=watched.has(it.id), pct=progressPercent(it.id); const card=document.createElement('article'); card.className='card'+(isW?' watched':''); card.dataset.id=it.id; const wrap=document.createElement('div'); wrap.className='thumb-wrap'; wrap.innerHTML=`<img class=\"thumb\" src=\"https://i.ytimg.com/vi/${it.id}/hqdefault.jpg\" alt=\"${it.title}\"><div class=\"watched-overlay\"><span>Watched</span></div><div class=\"duration\">${formatDuration(durations.get(it.id))}</div><div class=\"progress\"><span style=\"width:${pct}%\"></span></div>`; const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<h3>${it.title}</h3><div class=\"sub\">Episode ${i+1}</div>`; const btn=document.createElement('button'); btn.className='btn watch'; btn.textContent=isW?'Watch again':'Watch'; btn.onclick=()=>openPlayer(it); card.appendChild(wrap); card.appendChild(meta); card.appendChild(btn); c.appendChild(card); }); }

    function progressPercent(id){ const d=durations.get(id)||0, t=progress.get(id)||0; if(!d) return 0; return Math.min(100,(t/d)*100); }
    function updateCardProgress(id){ const el=document.querySelector(`.card[data-id="${id}"] .progress span`); if(el) el.style.width=progressPercent(id)+'%'; }

    document.getElementById('q').oninput=e=>{ const q=e.target.value.toLowerCase(); filtered=items.filter(it=>it.title.toLowerCase().includes(q)); render(); };
    document.getElementById('playAll').onclick=async()=>{ try{ player.loadPlaylist({list:PLAYLIST_ID,listType:'playlist',index:0}); player.playVideo(); }catch(_){} openModal(); await hydratePlaylistIds(); if(!items.length&&playlistVideoIds.length) buildCards(); };

    async function fetchAllDurationsSequential(){ for(const id of playlistVideoIds){ if(!durations.has(id)){ await fetchDurationFor(id); render(); } } try{ player.cuePlaylist({list:PLAYLIST_ID,listType:'playlist',index:0}); }catch(_){} }
    function fetchDurationFor(id){ return new Promise(res=>{ try{ player.cueVideoById(id); const s=Date.now(); const t=setInterval(()=>{ let d=0; try{ d=player.getDuration(); }catch(_){} if(d){ clearInterval(t); durations.set(id,d); res(); } else if(Date.now()-s>4000){ clearInterval(t); res(); } },150); }catch(_){ res(); } }); }
    function formatDuration(sec){ if(!sec) return ''; sec=Math.floor(sec); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; const pad=n=>String(n).padStart(2,'0'); return h?`${h}:${pad(m)}:${pad(s)}`:`${m}:${pad(s)}`; }

    function openPlayer(item){ const last=progress.get(item.id)||0, dur=durations.get(item.id)||0; let start=0; if(last>3 && dur && last<dur-2) start=last; try{ player.loadVideoById({videoId:item.id,startSeconds:start}); player.playVideo(); }catch(_){} openModal(); }

    function openModal(){ const m=document.getElementById('modal'); m.showModal(); document.getElementById('closeBtn').style.display='block'; }
    function closeModal(){ const m=document.getElementById('modal'); if(m.open) m.close(); document.getElementById('closeBtn').style.display='none'; try{ player.pauseVideo(); }catch(_){} stopProgressTicker(); saveProgress(); }
    document.getElementById('closeBtn').onclick=closeModal;
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
  </script>
</body>
</html>
